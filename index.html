<!--
- ??? Select the input device combo?
- Create a chart to show the decibilimeter
- Create a variable to define the value to achieve when the crowd scream
- create a simple blog with dummy posts
- Integrate with WP REST API to post trigger and somehing
- the post that will be created needs to have the informations about the event and dB achieved for the crowd.
- when achive the meta explode the element and show a message "POST PUBLISHED!"

****************

||||| Topics for the presentation
- references, libs, ideas, prototypes
- how to use rest api
- application for the rest api
 -->



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/styles/post-scream.css" />
</head>
<body>
  <div class="row content">
    <div class="col-md-9 chart">
      <div id="higher-db"><span></span></div>
      <div id="meter"><span></span></div>
    </div>
    <div class="col-md-3 dashboard">
      <div class="buttons">
        <h3>Goal</h3>
        <div class="input-group form-group">
          <span class="input-group-addon" id="basic-addon1">dB</span>
          <input type="text" class="form-control" name="db-goal" id="db-goal" value="0.10">
        </div>
        <h3>Actions</h3>
          <div class="form-group">
          <input type="button" class="btn btn-success" value="Start listen" onclick="startListening();" />
          <input type="button" class="btn btn btn-danger" value="Stop listen" onclick="stopListening();" />
          <input type="button" class="btn btn btn-secondary" value="Clear" />
        </div>
        <div class="form-group">
          <label for="results">Live Results</label>
          <textarea class="form-control" id="results"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/jquery-ui-npm/jquery-ui.min.js"></script>
  <script src="node_modules/decibel-meter/dist/decibel-meter.js"></script>
  <script>
    const meter      = new DecibelMeter('meter');
    const levelEl    = $('#meter > span');
    const dbGoalEl   = $('#db-goal');
    const resultsEl  = $('#results');
    const higherDbEl = $('#higher-db');

    function startListening() {
      var appendDb = '';
      var higherDb = 0;
      connectToSource();
      meter.listen();
      meter.on('sample', (dB, percent, value) => {
        dB = dB + 100; // convert to positive value

        if ( value >= dbGoalEl.val()) {

          if ( dB > higherDb){
            higherDb = dB;
            higherDbEl.css('bottom', higherDb + '%');
            higherDbEl.find('span').text(Math.round(higherDb) + 'dB');
            // console.log('higher: ' + higherDb);
          }


        levelEl.css('height', Math.round(dB) + '%');
        levelEl.text( Math.round(dB) + '%');

         //  $( "#meter" ).effect('explode', {pieces: 32}, 3000, function() {
         //     $(this).show()
         // });
        }


        resultsEl.append(dB + 'dB' + '\n');
        resultsEl.scrollTop(resultsEl[0].scrollHeight);

        // console.log(`${dB} dB`);
        // console.log(`${percent} %`);
        // console.log(`${value} val`);
        // console.log('-----------------------');

      });
    }

    function stopListening() {
      meter.stopListening();
      // diconnectToSource();
    }

    function connectToSource() {
      meter.sources.then(sources => {
          meter.connect(sources[0])
      });
    }

    function diconnectToSource() {
      meter.disconnect();
    }

  </script>

</body>
</html>